<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="会熟练拼写Python、Java、React"><title>Linux-内存分析 | 一点知识</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Linux-内存分析</h1><a id="logo" href="/.">一点知识</a><p class="description">xukf</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/diary/"><i class="fa fa-book"> 日志</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Linux-内存分析</h1><div class="post-meta">May 8, 2018<span> | </span><span class="category"><a href="/categories/后台/">后台</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2,919</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 13</span><span class="post-meta-item-text"> 分钟</span></span></span><script type="text/javascript" src="/js/love.js"></script></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#起因"><span class="toc-number">1.</span> <span class="toc-text">起因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free命令"><span class="toc-number">2.</span> <span class="toc-text">free命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#top命令"><span class="toc-number">3.</span> <span class="toc-text">top命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VIRT"><span class="toc-number">3.1.</span> <span class="toc-text">VIRT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RES"><span class="toc-number">3.2.</span> <span class="toc-text">RES</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SHR"><span class="toc-number">3.3.</span> <span class="toc-text">SHR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DATA"><span class="toc-number">3.4.</span> <span class="toc-text">DATA</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#proc-meminfo"><span class="toc-number">4.</span> <span class="toc-text">/proc/meminfo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MemTotal"><span class="toc-number">4.1.</span> <span class="toc-text">MemTotal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MemFree"><span class="toc-number">4.2.</span> <span class="toc-text">MemFree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MemAvailable"><span class="toc-number">4.3.</span> <span class="toc-text">MemAvailable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PageTables"><span class="toc-number">4.4.</span> <span class="toc-text">PageTables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Buffers"><span class="toc-number">4.5.</span> <span class="toc-text">Buffers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cached"><span class="toc-number">4.6.</span> <span class="toc-text">Cached</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SwapCached"><span class="toc-number">4.7.</span> <span class="toc-text">SwapCached</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LRU"><span class="toc-number">4.8.</span> <span class="toc-text">LRU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shmem"><span class="toc-number">4.9.</span> <span class="toc-text">Shmem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AnonPages"><span class="toc-number">4.10.</span> <span class="toc-text">AnonPages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mapped"><span class="toc-number">4.11.</span> <span class="toc-text">Mapped</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主要关系图"><span class="toc-number">4.12.</span> <span class="toc-text">主要关系图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#proc-pid-smaps"><span class="toc-number">5.</span> <span class="toc-text">/proc/pid/smaps</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#各命令之间的关系比对"><span class="toc-number">6.</span> <span class="toc-text">各命令之间的关系比对</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">7.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><div class="post-content"><p>分析Linux内存使用情况，包括：<code>free</code>命令展示内容分析；<code>top</code>命令中内存部分分析；<code>/proc/meminfo</code>中内存部分分析；<br><a id="more"></a></p>
<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>想要对线上主机的进程占用内存情况进行监控，原来很简单的使用的是<code>free</code>命令的<code>used</code>来表示的内存使用情况，目前已不能满足监控要求，需要分析<code>free</code>、<code>top</code>、<code>/proc/meminfo</code>各字段含义，以及找出符合需求的方案。</p>
<h2 id="free命令"><a href="#free命令" class="headerlink" title="free命令"></a><code>free</code>命令</h2><p><code>free</code>命令输出格式如下：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[~]$ free -k</span><br><span class="line">             total       used       free     shared    buffers     cached</span><br><span class="line">Mem:      <span class="number">49449300</span>   <span class="number">24798084</span>   <span class="number">24651216</span>          <span class="number">0</span>    <span class="number">3602016</span>   <span class="number">15910220</span></span><br><span class="line">-/+ buffers/cache:    <span class="number">5285848</span>   <span class="number">44163452</span></span><br><span class="line">Swap:     <span class="number">33554424</span>   <span class="number">14794692</span>   <span class="number">18759732</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>Mem<ul>
<li>total：内存总量</li>
<li>used：内存使用量，包含<code>buffers</code>与<code>cached</code></li>
<li>free：空闲内存量</li>
<li>buffers、cached：缓存内存量</li>
</ul>
</li>
<li>-/+ buffers/cache<ul>
<li>used：used – buffers – cached</li>
<li>free：free + buffers + cached</li>
</ul>
</li>
<li>Swap：交换区</li>
</ul>
<p>存在的关系为：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mem：total = used + free</span><br><span class="line">     实际已用内存 = total - <span class="keyword">buffers </span>- <span class="keyword">cached</span></span><br><span class="line"><span class="keyword"> </span>    空闲内存 = free + <span class="keyword">buffers </span>+ <span class="keyword">cached</span></span><br></pre></td></tr></table></figure></p>
<p>还有另一种<code>free</code>命令结果：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[~]$ free -k</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:     <span class="number"> 263848376 </span>  <span class="number"> 21822408 </span>    <span class="number"> 836740 </span>    <span class="number"> 968264 </span> <span class="number"> 241189228 </span>  240590568</span><br><span class="line">Swap:    <span class="number"> 134217724 </span>    <span class="number"> 562320 </span>  133655404</span><br></pre></td></tr></table></figure></p>
<p>与上一种不同的是：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Mem</span><br><span class="line">  used为实际使用量</span><br><span class="line">  total = used + <span class="built_in">free</span> + buff/cache</span><br><span class="line">  available = 可回收的内存 + <span class="built_in">free</span> 表示系统可用的内存，不过这是一个估计值，并不精确</span><br></pre></td></tr></table></figure></p>
<h2 id="top命令"><a href="#top命令" class="headerlink" title="top命令"></a><code>top</code>命令</h2><p><code>top</code>命令输出格式如下：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[~]$ top</span><br><span class="line">top - 23:29:48 up<span class="number"> 699 </span>days,  7:17, <span class="number"> 6 </span>users,  load average: 1.65, 1.30, 1.22</span><br><span class="line">Tasks:<span class="number"> 773 </span>total,  <span class="number"> 1 </span>running,<span class="number"> 772 </span>sleeping,  <span class="number"> 0 </span>stopped,  <span class="number"> 0 </span>zombie</span><br><span class="line">Cpu(s):  3.6%us,  2.8%sy,  0.0%ni, 93.5%id,  0.1%wa,  0.0%hi,  0.0%si,  0.0%st</span><br><span class="line">Mem:  49449300k total, 24823852k used, 24625448k free,  3602116k buffers</span><br><span class="line">Swap: 33554424k total, 14794692k used, 18759732k free, 15911860k cached</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND</span><br><span class="line">22326 root     <span class="number"> 18 </span> <span class="number"> 0 </span>9963m 679m<span class="number"> 2472 </span>S 100.7  1.4 167891:08 java   </span><br><span class="line">27893 aiuap_jc <span class="number"> 15 </span> <span class="number"> 0 </span>13272<span class="number"> 1616 </span><span class="number"> 808 </span>R  1.0  0.0   0:00.06 top     </span><br><span class="line">   <span class="number"> 1 </span>root     <span class="number"> 15 </span> <span class="number"> 0 </span>10348  <span class="number"> 96 </span> <span class="number"> 64 </span>S  0.0  0.0  29:29.83 init</span><br></pre></td></tr></table></figure></p>
<p>其中Mem行与Swap行与<code>free</code>命令输出结果能够一一对应<br>对于每个进程来说：</p>
<h3 id="VIRT"><a href="#VIRT" class="headerlink" title="VIRT"></a>VIRT</h3><p>virtual memory usage 虚拟内存<br>进程需要的虚拟内存大小，并不是实际占用的物理内存大小，包括了进程使用的库、代码、数据等</p>
<blockquote>
<p>假如进程申请100m的内存，但实际只使用了10m，那么它会增长100m，而不是实际的使用量</p>
</blockquote>
<h3 id="RES"><a href="#RES" class="headerlink" title="RES"></a>RES</h3><p>resident memory usage 常驻内存<br>进程当前使用的内存，<strong>包括与其他程序的共享内存</strong>，但不包括swap out</p>
<blockquote>
<p>如果申请100m的内存，实际使用10m，它只增长10m，与VIRT相反<br>关于库占用内存的情况，它只统计加载的库文件所占内存大小</p>
</blockquote>
<h3 id="SHR"><a href="#SHR" class="headerlink" title="SHR"></a>SHR</h3><p>shared memory 共享内存<br>当前进程自身/其他进程的共享内存  </p>
<blockquote>
<p>虽然进程只使用了几个共享库的函数，但它包含了整个共享库的大小</p>
</blockquote>
<p>某个进程独占的物理内存大小 = RES – SHR</p>
<h3 id="DATA"><a href="#DATA" class="headerlink" title="DATA"></a>DATA</h3><p><code>top</code>命令还有一个<code>DATA</code>一项（需要f手工添加），表示该程序数据占用的内存。</p>
<h2 id="proc-meminfo"><a href="#proc-meminfo" class="headerlink" title="/proc/meminfo"></a><code>/proc/meminfo</code></h2><p><code>/proc/meminfo</code>内容如下：<br><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[~]$ cat /<span class="keyword">proc</span>/meminfo</span><br><span class="line">MemTotal:       263848376<span class="title"> kB</span></span><br><span class="line"><span class="title">MemFree:</span>          768316<span class="title"> kB</span></span><br><span class="line"><span class="title">MemAvailable:</span>   240574824<span class="title"> kB</span></span><br><span class="line"><span class="title">Buffers:</span>          377792<span class="title"> kB</span></span><br><span class="line"><span class="title">Cached:</span>         233359392<span class="title"> kB</span></span><br><span class="line"><span class="title">SwapCached:</span>         1480<span class="title"> kB</span></span><br><span class="line"><span class="title">Active:</span>         139386604<span class="title"> kB</span></span><br><span class="line"><span class="title">Inactive:</span>       114406100<span class="title"> kB</span></span><br><span class="line"><span class="title">Active(anon):</span>   19662812<span class="title"> kB</span></span><br><span class="line"><span class="title">Inactive(anon):</span>  1360920<span class="title"> kB</span></span><br><span class="line"><span class="title">Active(file):</span>   119723792<span class="title"> kB</span></span><br><span class="line"><span class="title">Inactive(file):</span> 113045180<span class="title"> kB</span></span><br><span class="line"><span class="title">Unevictable:</span>           0<span class="title"> kB</span></span><br><span class="line"><span class="title">Mlocked:</span>               0<span class="title"> kB</span></span><br><span class="line"><span class="title">SwapTotal:</span>      134217724<span class="title"> kB</span></span><br><span class="line"><span class="title">SwapFree:</span>       133655284<span class="title"> kB</span></span><br><span class="line"><span class="title">Dirty:</span>            107808<span class="title"> kB</span></span><br><span class="line"><span class="title">Writeback:</span>             0<span class="title"> kB</span></span><br><span class="line"><span class="title">AnonPages:</span>      20054452<span class="title"> kB</span></span><br><span class="line"><span class="title">Mapped:</span>            34972<span class="title"> kB</span></span><br><span class="line"><span class="title">Shmem:</span>            968144<span class="title"> kB</span></span><br><span class="line"><span class="title">Slab:</span>            7506700<span class="title"> kB</span></span><br><span class="line"><span class="title">SReclaimable:</span>    7375420<span class="title"> kB</span></span><br><span class="line"><span class="title">SUnreclaim:</span>       131280<span class="title"> kB</span></span><br><span class="line"><span class="title">KernelStack:</span>        6240<span class="title"> kB</span></span><br><span class="line"><span class="title">PageTables:</span>        47808<span class="title"> kB</span></span><br><span class="line"><span class="title">NFS_Unstable:</span>          0<span class="title"> kB</span></span><br><span class="line"><span class="title">Bounce:</span>                0<span class="title"> kB</span></span><br><span class="line"><span class="title">WritebackTmp:</span>          0<span class="title"> kB</span></span><br><span class="line"><span class="title">CommitLimit:</span>    266141912<span class="title"> kB</span></span><br><span class="line"><span class="title">Committed_AS:</span>   27851440<span class="title"> kB</span></span><br><span class="line"><span class="title">VmallocTotal:</span>   34359738367<span class="title"> kB</span></span><br><span class="line"><span class="title">VmallocUsed:</span>      733404<span class="title"> kB</span></span><br><span class="line"><span class="title">VmallocChunk:</span>   34222675168<span class="title"> kB</span></span><br><span class="line"><span class="title">HardwareCorrupted:</span>     0<span class="title"> kB</span></span><br><span class="line"><span class="title">AnonHugePages:</span>   5552128<span class="title"> kB</span></span><br><span class="line"><span class="title">HugePages_Total:</span>       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048<span class="title"> kB</span></span><br><span class="line"><span class="title">DirectMap4k:</span>      129792<span class="title"> kB</span></span><br><span class="line"><span class="title">DirectMap2M:</span>     3936256<span class="title"> kB</span></span><br><span class="line"><span class="title">DirectMap1G:</span>    266338304<span class="title"> kB</span></span><br></pre></td></tr></table></figure></p>
<p>这部分内容基本是根据<a href="http://linuxperf.com/?p=142" target="_blank" rel="noopener">/PROC/MEMINFO之谜</a>进行学习的，建议看原文章，本节下面的内容主要是便于自身理解。<br>其中：</p>
<h3 id="MemTotal"><a href="#MemTotal" class="headerlink" title="MemTotal"></a>MemTotal</h3><p>可供支配的总内存大小</p>
<h3 id="MemFree"><a href="#MemFree" class="headerlink" title="MemFree"></a>MemFree</h3><p>尚未使用的内存，MemTotal-MemFree表示已经用过的内存，但不等于可用内存，因为有部分内存可回收释放</p>
<h3 id="MemAvailable"><a href="#MemAvailable" class="headerlink" title="MemAvailable"></a>MemAvailable</h3><p>可用内存，这是内核估算出来的值，并不十分精确，等于部分可回收的内存+MemFree</p>
<h3 id="PageTables"><a href="#PageTables" class="headerlink" title="PageTables"></a>PageTables</h3><p>Page Table用于将内存的虚拟地址翻译成物理地址，随着内存地址分配得越来越多，Page Table会增大，pageTables表示Page Table的大小</p>
<h3 id="Buffers"><a href="#Buffers" class="headerlink" title="Buffers"></a>Buffers</h3><p>表示块设备(block device)所占用的缓存页，包括：直接读写块设备、以及文件系统元数据(metadata)比如SuperBlock所使用的缓存页；<br>这部分可以理解为直接与块设备进行读写，所以需要缓存页的使用，例如使用dd命令进行复制等。因为块设备的读写是按照块来进行的，引入缓冲区后，可以避免小数据量的改动导致重复对块（可能是块下的扇区）进行读写，提高效率。</p>
<h3 id="Cached"><a href="#Cached" class="headerlink" title="Cached"></a>Cached</h3><p>包括正被用户使用到的文件的缓存页+原用过但并没有回收的页面，即包括：Mapped与unmapped的页面。</p>
<h3 id="SwapCached"><a href="#SwapCached" class="headerlink" title="SwapCached"></a>SwapCached</h3><p>交换区缓存，是交换区设备的缓存。</p>
<blockquote>
<p>交换区可以包括一个或多个交换区设备（裸盘、逻辑卷、文件都可以充当交换区设备），每一个交换区设备都对应自己的swap cache，可以把swap cache理解为交换区设备的”page cache”：page cache对应的是一个个文件，swap cache对应的是一个个交换区设备，kernel管理swap cache与管理page cache一样，用的都是radix-tree，唯一的区别是：page cache与文件的对应关系在打开文件时就确定了，而一个匿名页只有在即将被swap-out的时候才决定它会被放到哪一个交换区设备，即匿名页与swap cache的对应关系在即将被swap-out时才确立。  </p>
<p>并不是每一个匿名页都在swap cache中，只有以下情形之一的匿名页才在：  </p>
<p>匿名页即将被swap-out时会先被放进swap cache，但通常只存在很短暂的时间，因为紧接着在pageout完成之后它就会从swap cache中删除，毕竟swap-out的目的就是为了腾出空闲内存；<br>【注：参见mm/vmscan.c: shrink_page_list()，它调用的add_to_swap()会把swap cache页面标记成dirty，然后它调用try_to_unmap()将页面对应的page table mapping都删除，再调用pageout()回写dirty page，最后try_to_free_swap()会把该页从swap cache中删除。】<br>曾经被swap-out现在又被swap-in的匿名页会在swap cache中，直到页面中的内容发生变化、或者原来用过的交换区空间被回收为止。<br>【注：当匿名页的内容发生变化时会删除对应的swap cache，代码参见mm/swapfile.c: reuse_swap_page()。】  </p>
<p>/proc/meminfo中的SwapCached背后的含义是：系统中有多少匿名页曾经被swap-out、现在又被swap-in并且swap-in之后页面中的内容一直没发生变化。也就是说，如果这些匿名页需要被swap-out的话，是无需进行I/O write操作的。</p>
</blockquote>
<p>需要注意的是，<code>Cached</code>与<code>SwapCached</code>两个统计值是互不重叠的，Shared memory和tmpfs在不发生swap-out的时候属于”Cached”，而在swap-out/swap-in的过程中会被加进swap cache中、属于”SwapCached”，一旦进了”SwapCached”，就不再属于”Cached”了。</p>
<h3 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h3><blockquote>
<p>用户进程的内存页分为两种：file-backed pages（与文件对应的内存页），和anonymous pages（匿名页），比如进程的代码、映射的文件都是file-backed，而进程的堆、栈都是不与文件相对应的、就属于匿名页。file-backed pages在内存不足的时候可以直接写回对应的硬盘文件里，称为page-out，不需要用到交换区(swap)；而anonymous pages在内存不足时就只能写到硬盘上的交换区(swap)里，称为swap-out。  </p>
<p>file 表示 file-backed pages（与文件对应的内存页）</p>
</blockquote>
<p>理论上应该有：<br><strong>【所有进程的PSS之和】 == 【Mapped + AnonPages】</strong></p>
<blockquote>
<p>实际测试的结果，虽然两者很接近，却总是无法精确相等，我猜也许是因为进程始终在变化、采集的/proc/[1-9]*/smaps以及/proc/meminfo其实不是来自同一个时间点的缘故。</p>
</blockquote>
<h3 id="Shmem"><a href="#Shmem" class="headerlink" title="Shmem"></a>Shmem</h3><p>主要包括：</p>
<ul>
<li>shared memory（基于tmpfs实现）</li>
<li>tmpfs  </li>
</ul>
<p>Shmem 统计的是已经分配的大小，而不是创建时申请的大小</p>
<h3 id="AnonPages"><a href="#AnonPages" class="headerlink" title="AnonPages"></a>AnonPages</h3><ul>
<li>所有page cache里的页面(Cached)都是file-backed pages，不是Anonymous Pages。”Cached”与”AnoPages”之间没有重叠。<br>注：shared memory 不属于 AnonPages，而是属于Cached，因为shared memory基于tmpfs，所以被视为file-backed、在page cache里，上一节解释过。</li>
<li>mmap private anonymous pages属于AnonPages(Anonymous Pages)，而mmap shared anonymous pages属于Cached(file-backed pages)，因为shared anonymous mmap也是基于tmpfs的。</li>
<li>Anonymous Pages是与用户进程共存的，一旦进程退出，则Anonymous pages也释放，不像page cache即使文件与进程不关联了还可以缓存。</li>
<li>AnonPages统计值中包含了Transparent HugePages (THP)对应的 AnonHugePages</li>
</ul>
<h3 id="Mapped"><a href="#Mapped" class="headerlink" title="Mapped"></a>Mapped</h3><p>用户进程的file-backed pages就对应着/proc/meminfo中的”Mapped”</p>
<blockquote>
<p>正被用户进程关联，比如shared libraries、可执行程序的文件、mmap的文件等，这些文件的缓存页就称为mapped  </p>
<p>”Mapped”是”Cached”的子集</p>
</blockquote>
<h3 id="主要关系图"><a href="#主要关系图" class="headerlink" title="主要关系图"></a>主要关系图</h3><p><code>/proc/meminfo</code>中主要字段关系为，这个图描述可能过于简洁，导致一些地方存在偏差，只是提供分析方法。<br><img src="https://upload-images.jianshu.io/upload_images/6101555-c5e0fc1ffe940439.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="Linux中meminfo相关信息关系"></p>
<h2 id="proc-pid-smaps"><a href="#proc-pid-smaps" class="headerlink" title="/proc/pid/smaps"></a>/proc/pid/smaps</h2><p>每个进程都有的文件，记录了进程信息，其中有内存使用情况。</p>
<p>如果要统计所有进程占用的内存，并且共享内存不重复记录，则可以通过：<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep Pss /<span class="function"><span class="keyword">proc</span>/[<span class="number">1</span><span class="number">-9</span>]*/<span class="title">smaps</span> | <span class="title">awk</span>  '&#123;<span class="title">total</span>+=$<span class="number">2</span>&#125;</span>; <span class="keyword">END</span> &#123;<span class="keyword">print</span> total&#125;'</span><br></pre></td></tr></table></figure></p>
<p>需要注意的是，可能有的pid下的/smaps没有权限访问……</p>
<p>同时：top命令输出中的RES和pmap输出中的RSS是一个东西</p>
<h2 id="各命令之间的关系比对"><a href="#各命令之间的关系比对" class="headerlink" title="各命令之间的关系比对"></a>各命令之间的关系比对</h2><p>top<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[~]$ top</span><br><span class="line">top - <span class="number">00</span>:<span class="number">15</span>:<span class="number">31</span> up <span class="number">699</span> days,  <span class="number">8</span>:<span class="number">03</span>,  <span class="number">6</span> users,  load average: <span class="number">1</span>.<span class="number">65</span>, <span class="number">1</span>.<span class="number">27</span>, <span class="number">1</span>.<span class="number">24</span></span><br><span class="line">Tasks: <span class="number">780</span> total,<span class="number">5</span> running, <span class="number">775</span> sleeping,<span class="number">0</span> stopped,<span class="number">0</span> zombie</span><br><span class="line">Cpu(s):  <span class="number">6</span>.<span class="number">3</span>%us,  <span class="number">4</span>.<span class="number">7</span>%sy,  <span class="number">0</span>.<span class="number">0</span>%ni, <span class="number">88</span>.<span class="number">5</span>%id,  <span class="number">0</span>.<span class="number">6</span>%wa,  <span class="number">0</span>.<span class="number">0</span>%hi,  <span class="number">0</span>.<span class="number">0</span>%si,  <span class="number">0</span>.<span class="number">0</span>%st</span><br><span class="line">Mem:  <span class="number">49449300</span>k total, <span class="number">24825488</span>k used, <span class="number">24623812</span>k free,  <span class="number">3602140</span>k buffers</span><br><span class="line">Swap: <span class="number">33554424</span>k total, <span class="number">14794692</span>k used, <span class="number">18759732</span>k free, <span class="number">15912372</span>k cached</span><br><span class="line"></span><br><span class="line">  PID USERPR  NI  VIRT  RES  SHR S %CPU %MEM TIME+  COMMAND  </span><br><span class="line"><span class="number">22326</span> root180 <span class="number">9963m</span> <span class="number">662m</span> <span class="number">2472</span> S <span class="number">101</span>.<span class="number">0</span>  <span class="number">1.4 167937</span>:<span class="number">49</span> java  </span><br><span class="line"><span class="number">17775</span> app_usr160  <span class="number">247m</span>  <span class="number">12m</span> <span class="number">5276</span> S  <span class="number">1</span>.<span class="number">3</span>  <span class="number">0.00:00.57</span> python</span><br><span class="line"><span class="number">18304</span> app_usr<span class="number">150 13272</span> <span class="number">1644</span>  <span class="number">808</span> R  <span class="number">0</span>.<span class="number">7</span>  <span class="number">0.00:00.05</span> top</span><br><span class="line"><span class="number">18426</span> app_usr180  <span class="number">247m</span>  <span class="number">11m</span> <span class="number">3776</span> R  <span class="number">0</span>.<span class="number">7</span>  <span class="number">0.00:00.02</span> python</span><br><span class="line"><span class="number">18425</span> app_usr180  <span class="number">247m</span>  <span class="number">11m</span> <span class="number">3776</span> R  <span class="number">0</span>.<span class="number">3</span>  <span class="number">0.00:00.01</span> python</span><br></pre></td></tr></table></figure></p>
<p>free<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[~]$ free -k</span><br><span class="line">             total       used       free     shared    buffers     cached</span><br><span class="line">Mem:      <span class="number">49449300</span>   <span class="number">24820228</span>   <span class="number">24629072</span>          <span class="number">0</span>    <span class="number">3602140</span>   <span class="number">15912372</span></span><br><span class="line">-/+ buffers/cache:    <span class="number">5305716</span>   <span class="number">44143584</span></span><br><span class="line">Swap:     <span class="number">33554424</span>   <span class="number">14794692</span>   <span class="number">18759732</span></span><br></pre></td></tr></table></figure></p>
<p>/proc/meminfo<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[~]$ cat <span class="meta-keyword">/proc/</span>meminfo</span><br><span class="line"><span class="symbol">MemTotal:</span>     <span class="number">49449300</span> kB</span><br><span class="line"><span class="symbol">MemFree:</span>      <span class="number">24631608</span> kB</span><br><span class="line"><span class="symbol">Buffers:</span>       <span class="number">3602140</span> kB</span><br><span class="line"><span class="symbol">Cached:</span>       <span class="number">15912388</span> kB</span><br><span class="line"><span class="symbol">SwapCached:</span>    <span class="number">2354868</span> kB</span><br><span class="line"><span class="symbol">Active:</span>       <span class="number">10286124</span> kB</span><br><span class="line"><span class="symbol">Inactive:</span>     <span class="number">13448900</span> kB</span><br><span class="line"><span class="symbol">HighTotal:</span>           <span class="number">0</span> kB</span><br><span class="line"><span class="symbol">HighFree:</span>            <span class="number">0</span> kB</span><br><span class="line"><span class="symbol">LowTotal:</span>     <span class="number">49449300</span> kB</span><br><span class="line"><span class="symbol">LowFree:</span>      <span class="number">24631608</span> kB</span><br><span class="line"><span class="symbol">SwapTotal:</span>    <span class="number">33554424</span> kB</span><br><span class="line"><span class="symbol">SwapFree:</span>     <span class="number">18759732</span> kB</span><br><span class="line"><span class="symbol">Dirty:</span>            <span class="number">1696</span> kB</span><br><span class="line"><span class="symbol">Writeback:</span>           <span class="number">0</span> kB</span><br><span class="line"><span class="symbol">AnonPages:</span>     <span class="number">1965432</span> kB</span><br><span class="line"><span class="symbol">Mapped:</span>          <span class="number">38332</span> kB</span><br><span class="line"><span class="symbol">Slab:</span>           <span class="number">890560</span> kB</span><br><span class="line"><span class="symbol">PageTables:</span>      <span class="number">84276</span> kB</span><br><span class="line"><span class="symbol">NFS_Unstable:</span>        <span class="number">0</span> kB</span><br><span class="line"><span class="symbol">Bounce:</span>              <span class="number">0</span> kB</span><br><span class="line"><span class="symbol">CommitLimit:</span>  <span class="number">58279072</span> kB</span><br><span class="line"><span class="symbol">Committed_AS:</span> <span class="number">20471392</span> kB</span><br><span class="line"><span class="symbol">VmallocTotal:</span> <span class="number">34359738367</span> kB</span><br><span class="line"><span class="symbol">VmallocUsed:</span>    <span class="number">279448</span> kB</span><br><span class="line"><span class="symbol">VmallocChunk:</span> <span class="number">34359458679</span> kB</span><br><span class="line"><span class="symbol">HugePages_Total:</span>     <span class="number">0</span></span><br><span class="line"><span class="symbol">HugePages_Free:</span>      <span class="number">0</span></span><br><span class="line"><span class="symbol">HugePages_Rsvd:</span>      <span class="number">0</span></span><br><span class="line"><span class="symbol">Hugepagesize:</span>     <span class="number">2048</span> kB</span><br></pre></td></tr></table></figure></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ol>
<li><a href="http://linuxperf.com/?p=142" target="_blank" rel="noopener">/PROC/MEMINFO之谜</a></li>
<li><a href="https://javawind.net/p131" target="_blank" rel="noopener">linux top命令VIRT,RES,SHR,DATA的含义</a></li>
<li><a href="https://segmentfault.com/a/1190000008125006" target="_blank" rel="noopener">Linux内存管理</a></li>
<li><a href="https://www.cnblogs.com/lifexy/p/7651667.html" target="_blank" rel="noopener">22.Linux-块设备驱动之框架详细分析(详解)</a></li>
<li><a href="http://linuxperf.com/?p=143" target="_blank" rel="noopener">怎样统计所有进程总共占用多少内存？</a></li>
</ol>
<hr>
<p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png"></a><br>本作品采用<a rel="noopener" href="http://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank">知识共享署名-非商业性使用-禁止演绎 3.0 未本地化版本许可协议</a>进行许可。</p>
</div><div class="tags"><a href="/tags/Linux/">Linux</a></div><div class="license-space"></div><div class="license-content"><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a><span>本作品采用</span><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">'知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议'</a><span>进行许可。</span></div><div class="license-space"></div><div class="post-nav"><a class="pre" href="/2018/05/09/Hexo-文章字数统计与阅读时长/">Hexo-文章字数统计与阅读时长</a><a class="next" href="/2018/05/03/Echarts-百度地图省分着色/">Echarts-百度地图省分着色</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/FreshMan/">FreshMan</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Whisper/">Whisper</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/划水/">划水</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台/">后台</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/js/" style="font-size: 23px;">js</a> <a href="/tags/Echarts/" style="font-size: 16.5px;">Echarts</a> <a href="/tags/Hexo/" style="font-size: 19.75px;">Hexo</a> <a href="/tags/GitHub/" style="font-size: 16.5px;">GitHub</a> <a href="/tags/划水/" style="font-size: 10px;">划水</a> <a href="/tags/OGG/" style="font-size: 13.25px;">OGG</a> <a href="/tags/Kafka/" style="font-size: 16.5px;">Kafka</a> <a href="/tags/Docker/" style="font-size: 19.75px;">Docker</a> <a href="/tags/Oracle/" style="font-size: 16.5px;">Oracle</a> <a href="/tags/ESLint/" style="font-size: 13.25px;">ESLint</a> <a href="/tags/Python/" style="font-size: 16.5px;">Python</a> <a href="/tags/React/" style="font-size: 19.75px;">React</a> <a href="/tags/lambda/" style="font-size: 10px;">lambda</a> <a href="/tags/svn/" style="font-size: 13.25px;">svn</a> <a href="/tags/Java/" style="font-size: 13.25px;">Java</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/设计/" style="font-size: 13.25px;">设计</a> <a href="/tags/Linux/" style="font-size: 13.25px;">Linux</a> <a href="/tags/源码/" style="font-size: 10px;">源码</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/11/LeetCode-第149场周赛/">LeetCode-第149场周赛</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/07/JS基础知识-数据类型篇/">JS基础知识-数据类型篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/07/JS基础知识-入门篇/">JS基础知识-入门篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/18/Kafka-Docker环境跨主机集群安装/">Kafka-Docker环境跨主机集群安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/12/OGG+Kafka-目标端配置/">OGG+Kafka-目标端配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/02/JS-自定义事件触发在React中使用-高度自适应例/">JS-自定义事件触发在React中使用-高度自适应例</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/29/JS-参数对象新增方法/">JS-参数对象新增方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/JS-创建对象/">JS-创建对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/02/JS-bind方法参数分析/">JS-bind方法参数分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/01/OGG+Kafka-集群重启记/">OGG+Kafka-集群重启记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://strcpy.me/" title="strcpy" target="_blank">strcpy</a><ul></ul><a href="https://www.haomwei.com/" title="tufu9441" target="_blank">tufu9441</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">一点知识.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '24bfbdc1d2098a8d5cb427714572bbd5';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>