<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="会熟练拼写Python、Java、React"><title>Kafka-Docker环境跨主机集群安装 | 一点知识</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kafka-Docker环境跨主机集群安装</h1><a id="logo" href="/.">一点知识</a><p class="description">xukf</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/diary/"><i class="fa fa-book"> 日志</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kafka-Docker环境跨主机集群安装</h1><div class="post-meta">Feb 18, 2019<span> | </span><span class="category"><a href="/categories/后台/">后台</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1,929</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 9</span><span class="post-meta-item-text"> 分钟</span></span></span><script type="text/javascript" src="/js/love.js"></script></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#环境准备"><span class="toc-number">1.</span> <span class="toc-text">环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#主机"><span class="toc-number">1.1.</span> <span class="toc-text">主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#镜像"><span class="toc-number">1.2.</span> <span class="toc-text">镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用现有仓库中的镜像"><span class="toc-number">1.3.</span> <span class="toc-text">使用现有仓库中的镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#现有镜像提交私有仓库"><span class="toc-number">1.3.1.</span> <span class="toc-text">现有镜像提交私有仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置新增主机上Docker环境"><span class="toc-number">1.3.2.</span> <span class="toc-text">配置新增主机上Docker环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取私有仓库镜像"><span class="toc-number">1.3.3.</span> <span class="toc-text">获取私有仓库镜像</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kafka集群部署"><span class="toc-number">2.</span> <span class="toc-text">Kafka集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#容器启动"><span class="toc-number">2.1.</span> <span class="toc-text">容器启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置zk参数"><span class="toc-number">2.2.</span> <span class="toc-text">配置zk参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置主机身份"><span class="toc-number">2.2.1.</span> <span class="toc-text">配置主机身份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置zk端口号等"><span class="toc-number">2.2.2.</span> <span class="toc-text">配置zk端口号等</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动zk"><span class="toc-number">2.2.3.</span> <span class="toc-text">启动zk</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置Kafka"><span class="toc-number">2.3.</span> <span class="toc-text">配置Kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#参数文件配置"><span class="toc-number">2.3.1.</span> <span class="toc-text">参数文件配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动Kakfa"><span class="toc-number">2.3.2.</span> <span class="toc-text">启动Kakfa</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#遗留问题"><span class="toc-number">2.3.3.</span> <span class="toc-text">遗留问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">2.4.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后记"><span class="toc-number">2.5.</span> <span class="toc-text">后记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">2.6.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div></div><div class="post-content"><p>单节点主机多容器的Kafka集群挂掉了，进行三个节点主机Docker环境下的Kafka集群安装。<br><a id="more"></a></p>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="主机"><a href="#主机" class="headerlink" title="主机"></a>主机</h2><p>目前有三台物理机，计划对应zk+kafka节点为：</p>
<ul>
<li>172.10.0.1 –&gt; broker1</li>
<li>172.10.0.2 –&gt; broker2</li>
<li>172.10.0.3 –&gt; broker3</li>
</ul>
<h2 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h2><p>使用的ZK为：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">zookeeper-3</span><span class="selector-class">.4</span><span class="selector-class">.13</span></span><br></pre></td></tr></table></figure></p>
<p>使用的Kafka为：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kafka_2</span><span class="selector-class">.11-2</span><span class="selector-class">.0</span><span class="selector-class">.0</span></span><br></pre></td></tr></table></figure></p>
<p>Dockerfile文件为：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker image of kafka cluster</span></span><br><span class="line"><span class="comment"># VERSION 0.0.1</span></span><br><span class="line"><span class="comment"># Author: xukf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> daocloud.io/centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#作者</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> xukf &lt;xukf.me&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义工作目录</span></span><br><span class="line"><span class="keyword">ENV</span> WORK_PATH /usr/local/work</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义日志目录</span></span><br><span class="line"><span class="keyword">ENV</span> LOG_PATH /usr/local/work/log</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义zookeeper的Data目录</span></span><br><span class="line"><span class="keyword">ENV</span> ZK_DATA_PATH $WORK_PATH/zkdata</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义zookeeper文件夹名称</span></span><br><span class="line"><span class="keyword">ENV</span> ZK_PACKAGE_NAME zookeeper-<span class="number">3.4</span>.<span class="number">13</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#定义kafka文件夹名称</span></span><br><span class="line"><span class="keyword">ENV</span> KAFKA_PACKAGE_NAME kafka_2.<span class="number">11</span>-<span class="number">2.0</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将kafka的bin目录加入PATH</span></span><br><span class="line"><span class="keyword">ENV</span> PATH $WORK_PATH/$KAFKA_PACKAGE_NAME/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装JDK</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./jdk-8u181-linux-x64.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="bash">ENV JAVA_HOME /usr/<span class="built_in">local</span>/jdk1.8.0_181</span></span><br><span class="line"><span class="bash">ENV JRE_HOME <span class="variable">$&#123;JAVA_HOME&#125;</span>/jre</span></span><br><span class="line"><span class="bash">ENV CLASSPATH .:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib</span></span><br><span class="line"><span class="bash">ENV PATH <span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$&#123;PATH&#125;</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#创建工作目录</span></span></span><br><span class="line"><span class="bash">RUN mkdir -p <span class="variable">$WORK_PATH</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#创建日志目录</span></span></span><br><span class="line"><span class="bash">RUN mkdir -p <span class="variable">$LOG_PATH</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#创建zookeeper的Data目录</span></span></span><br><span class="line"><span class="bash">RUN mkdir -p <span class="variable">$ZK_DATA_PATH</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#安装kafka</span></span></span><br><span class="line"><span class="bash">ADD ./kafka_2.11-2.0.0.tgz <span class="variable">$WORK_PATH</span>/</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#拷贝解压缩的zk</span></span></span><br><span class="line"><span class="bash">COPY ./<span class="variable">$ZK_PACKAGE_NAME</span> <span class="variable">$WORK_PATH</span>/<span class="variable">$ZK_PACKAGE_NAME</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="使用现有仓库中的镜像"><a href="#使用现有仓库中的镜像" class="headerlink" title="使用现有仓库中的镜像"></a>使用现有仓库中的镜像</h2><h3 id="现有镜像提交私有仓库"><a href="#现有镜像提交私有仓库" class="headerlink" title="现有镜像提交私有仓库"></a>现有镜像提交私有仓库</h3><p>Docker部署程序通过镜像直接拉取容器。将原来的Kafka节点镜像上传到私有仓库，新增主机上通过拉取镜像进行节点部署。</p>
<p>以broker2节点为例<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">push</span> <span class="number">172.10</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">5000</span>/broker2:<span class="number">0.0</span><span class="meta">.2</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置新增主机上Docker环境"><a href="#配置新增主机上Docker环境" class="headerlink" title="配置新增主机上Docker环境"></a>配置新增主机上Docker环境</h3><ul>
<li>主机上Docker环境搭建好</li>
<li>配置私有仓库信息</li>
</ul>
<p><code>daemon.json</code>文件大概是这个样子：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"storage-driver"</span>: <span class="string">"overlay"</span>,</span><br><span class="line">  <span class="attr">"max-concurrent-uploads"</span>: <span class="number">16</span>,</span><br><span class="line">  <span class="attr">"max-concurrent-downloads"</span>: <span class="number">16</span>,</span><br><span class="line">  <span class="attr">"graph"</span>:<span class="string">"/var/lib/docker"</span>,</span><br><span class="line">  <span class="attr">"insecure-registries"</span>:[<span class="string">"172.10.0.1:5000"</span>],</span><br><span class="line">  <span class="attr">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="attr">"max-size"</span>: <span class="string">"50m"</span>,</span><br><span class="line">    <span class="attr">"max-file"</span>: <span class="string">"6"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hosts"</span>:[<span class="string">"tcp://0.0.0.0:2376"</span>, <span class="string">"unix:///var/run/docker.sock"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>insecure-registries</code>配置为原单节点主机的私有仓库，如果私有仓库制定了端口号，需要配置上相应端口号。</p>
<p>注意配置完后，如果获取私有仓库镜像遇到下面报错信息，多半是json配置文件没有生效：</p>
<blockquote>
<p>Error response from daemon: Get <a href="https://172.10.0.1:5000/v2/" target="_blank" rel="noopener">https://172.10.0.1:5000/v2/</a>: http: server gave HTTP response to HTTPS client</p>
</blockquote>
<p>执行以下命令进行生效（root用户）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></p>
<h3 id="获取私有仓库镜像"><a href="#获取私有仓库镜像" class="headerlink" title="获取私有仓库镜像"></a>获取私有仓库镜像</h3><p>以broker2节点为例<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull <span class="number">172.10</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">5000</span>/broker2:<span class="number">0.0</span><span class="meta">.2</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Kafka集群部署"><a href="#Kafka集群部署" class="headerlink" title="Kafka集群部署"></a>Kafka集群部署</h1><h2 id="容器启动"><a href="#容器启动" class="headerlink" title="容器启动"></a>容器启动</h2><p>目前使用<code>docker-compose</code>来进行各主机上的容器管理：</p>
<ul>
<li>安装<code>docker-compose</code></li>
<li>配置yml文件</li>
</ul>
<p>以broker2节点为例：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  broker2:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="number">172.10</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5000/broker2:0.0.2</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">broker2</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"19092:19092"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"18888:18888"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"19888:19888"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"22181:22181"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"19012:22"</span></span><br><span class="line"><span class="attr">    tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    network_mode:</span> <span class="string">"host"</span></span><br><span class="line"><span class="attr">  producer1:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="number">172.10</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5000/producer:0.0.2</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">producer1</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"19013:22"</span></span><br><span class="line"><span class="attr">    tty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>由于主机上端口冲突，这里将Kafka的9092、zk的2181、2888、3888端口都进行了调整。<br>前期试过将Kafka的9092端口通过<code>bridge</code>模式，映射成19092，但是在配置Kafka的参数时遇到了问题，一直会提示有节点不可用：</p>
<blockquote>
<p>Connection to node xxxx could not be established. Broker may not be available</p>
</blockquote>
<p>猜测是无法正确解析外部ip或者port导致的。暂时解决方案是采用<code>host</code>模式进行连接。</p>
<p>完成启动容器</p>
<h2 id="配置zk参数"><a href="#配置zk参数" class="headerlink" title="配置zk参数"></a>配置zk参数</h2><h3 id="配置主机身份"><a href="#配置主机身份" class="headerlink" title="配置主机身份"></a>配置主机身份</h3><p>先要配置每个主机上zk的身份：<br>broker1容器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /usr/<span class="built_in">local</span>/work/zkdata/myid</span><br></pre></td></tr></table></figure></p>
<p>broker2容器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 2 &gt; /usr/<span class="built_in">local</span>/work/zkdata/myid</span><br></pre></td></tr></table></figure></p>
<p>broker3容器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 3 &gt; /usr/<span class="built_in">local</span>/work/zkdata/myid</span><br></pre></td></tr></table></figure></p>
<h3 id="配置zk端口号等"><a href="#配置zk端口号等" class="headerlink" title="配置zk端口号等"></a>配置zk端口号等</h3><p>在三个节点容器的<code>/usr/local/work/zookeeper-3.4.13/conf</code>目录下配置zoo.cfg文件，因为要进行端口调整，所以参数文件要注意配置<code>clientPort</code>、<code>server</code>两个地方：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that the initial</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that can pass between</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta">#</span><span class="bash"> the directory <span class="built_in">where</span> the snapshot is stored.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> not use /tmp <span class="keyword">for</span> storage, /tmp here is just</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> example sakes.</span></span><br><span class="line">dataDir=/usr/local/work/zkdata</span><br><span class="line"><span class="meta">#</span><span class="bash"> the port at <span class="built_in">which</span> the clients will connect</span></span><br><span class="line">clientPort=22181</span><br><span class="line"><span class="meta">#</span><span class="bash"> the maximum number of client connections.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> increase this <span class="keyword">if</span> you need to handle more clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash">maxClientCnxns=60</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Be sure to <span class="built_in">read</span> the maintenance section of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://zookeeper.apache.org/doc/current/zookeeperAdmin.html<span class="comment">#sc_maintenance</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of snapshots to retain <span class="keyword">in</span> dataDir</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Purge task interval <span class="keyword">in</span> hours</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set to <span class="string">"0"</span> to <span class="built_in">disable</span> auto purge feature</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autopurge.purgeInterval=1</span></span><br><span class="line">server.1=172.10.0.1:18888:19888</span><br><span class="line">server.2=172.10.0.2:18888:19888</span><br><span class="line">server.3=172.10.0.3:18888:19888</span><br></pre></td></tr></table></figure></p>
<p><strong>注意</strong>：如果2181端口号没正确配置，或者其他主机的无法正常访问，会导致zk报错提示无法连接</p>
<h3 id="启动zk"><a href="#启动zk" class="headerlink" title="启动zk"></a>启动zk</h3><p>启动：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/work/zookeeper-3.4.13/bin/zkServer.sh start</span><br></pre></td></tr></table></figure></p>
<p>查看状态：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/work/zookeeper-3.4.13/bin/zkServer.sh status</span><br></pre></td></tr></table></figure></p>
<p>如果有需要，可以正常停止：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/work/zookeeper-3.4.13/bin/zkServer.sh stop</span><br></pre></td></tr></table></figure></p>
<h2 id="配置Kafka"><a href="#配置Kafka" class="headerlink" title="配置Kafka"></a>配置Kafka</h2><h3 id="参数文件配置"><a href="#参数文件配置" class="headerlink" title="参数文件配置"></a>参数文件配置</h3><p>三个节点容器配置<code>/usr/local/work/kafka_2.11-2.0.0/config</code>目录下的<code>server.properties</code>文件，以broker2节点为例，主要配置为：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">############################# Socket Server Settings #############################</span><br><span class="line"></span><br><span class="line"># The address the socket server listens on. It will get the value returned <span class="keyword">from</span></span><br><span class="line"># java.net.InetAddress.getCanonicalHostName() <span class="keyword">if</span> not configured.</span><br><span class="line">#   FORMAT:</span><br><span class="line">#     listeners = listener_name:<span class="comment">//host_name:port</span></span><br><span class="line">#   EXAMPLE:</span><br><span class="line">#     listeners = PLAINTEXT:<span class="comment">//your.host.name:9092</span></span><br><span class="line">#listeners=PLAINTEXT:<span class="comment">//:9092</span></span><br><span class="line">listeners=PLAINTEXT:<span class="comment">//:19092</span></span><br><span class="line"></span><br><span class="line"># Hostname and port the broker will advertise to producers and consumers. If not set,</span><br><span class="line"># it uses the value for <span class="string">"listeners"</span> <span class="keyword">if</span> configured.  Otherwise, it will use the value</span><br><span class="line"># returned <span class="keyword">from</span> java.net.InetAddress.getCanonicalHostName().</span><br><span class="line">#advertised.listeners=PLAINTEXT:<span class="comment">//your.host.name:9092</span></span><br><span class="line">advertised.listeners=PLAINTEXT:<span class="comment">//172.10.0.2:19092</span></span><br><span class="line"></span><br><span class="line">############################# Zookeeper #############################</span><br><span class="line"></span><br><span class="line"># Zookeeper connection string (see zookeeper docs for details).</span><br><span class="line"># This is a comma separated host:port pairs, each corresponding to a zk</span><br><span class="line"># server. e.g. <span class="string">"127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002"</span>.</span><br><span class="line"># You can also append an optional chroot string to the urls to specify the</span><br><span class="line"># root directory for all kafka znodes.</span><br><span class="line">zookeeper.connect=localhost:<span class="number">22181</span></span><br></pre></td></tr></table></figure></p>
<p>将端口号进行了修改。</p>
<h3 id="启动Kakfa"><a href="#启动Kakfa" class="headerlink" title="启动Kakfa"></a>启动Kakfa</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup <span class="regexp">/usr/</span>local<span class="regexp">/work/</span>kafka_2.<span class="number">11</span>-<span class="number">2.0</span>.<span class="number">0</span><span class="regexp">/bin/</span>kafka-server-start.sh <span class="regexp">/usr/</span>local<span class="regexp">/work/</span>kafka_2.<span class="number">11</span>-<span class="number">2.0</span>.<span class="number">0</span><span class="regexp">/config/</span>server.properties &gt;<span class="regexp">/usr/</span>local<span class="regexp">/work/</span>log<span class="regexp">/kafka.log 2&gt;1 &amp;</span></span><br></pre></td></tr></table></figure>
<h3 id="遗留问题"><a href="#遗留问题" class="headerlink" title="遗留问题"></a>遗留问题</h3><p>这里存在一个问题，<code>zookeeper.connect</code>用的是本地的zk，没有使用zk的集群，所以本地zk挂掉了，这个kafka节点也会跟着挂掉。</p>
<p>在使用<code>bridge</code>模式下测试使用过如下配置，一直提示无法解析节点ip：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper.connect=<span class="number">172.10</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">22181</span>,<span class="number">172.10</span><span class="meta">.0</span><span class="meta">.2</span>:<span class="number">22181</span>,<span class="number">172.10</span><span class="meta">.0</span><span class="meta">.3</span>:<span class="number">22181</span></span><br></pre></td></tr></table></figure></p>
<p>查看报错信息，其他节点都是传递的容器ID，没有传递真正的主机IP，试过配置容器hosts来进行解析但失败了。分析可以试一下启容器的时候加入以下参数：<code>KAFKA_ADVERTISED_LISTENERS</code>，在配置文件中配置<code>advertised.listeners</code>，实现传递主机IP。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>生产者：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/work/kafka_2<span class="meta">.11</span>-<span class="number">2.0</span><span class="meta">.0</span>/bin/kafka-console-producer.sh --broker-list <span class="number">172.10</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">19092</span>,<span class="number">172.10</span><span class="meta">.0</span><span class="meta">.2</span>:<span class="number">19092</span>,<span class="number">172.10</span><span class="meta">.0</span><span class="meta">.3</span>:<span class="number">19092</span> --topic test001</span><br></pre></td></tr></table></figure></p>
<p>消费者<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/work/kafka_2<span class="meta">.11</span>-<span class="number">2.0</span><span class="meta">.0</span>/bin/kafka-console-consumer.sh  --bootstrap-server <span class="number">172.10</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">19092</span>,<span class="number">172.10</span><span class="meta">.0</span><span class="meta">.2</span>:<span class="number">19092</span>,<span class="number">172.10</span><span class="meta">.0</span><span class="meta">.3</span>:<span class="number">19092</span> --from-beginning --topic test010</span><br></pre></td></tr></table></figure></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>如果主机端口没有被占用，建议使用原有端口。</p>
<p>需要解决两个问题：</p>
<ol>
<li>目前Kafka与ZK是一对一的存在于容器中，配置的参数会发生某个zk的挂掉导致Kafka的挂掉。需要进行参数调整</li>
<li>使用的<code>host</code>模式不符合生产要求，以后要上生产环境需要调整</li>
</ol>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://blog.csdn.net/boling_cavalry/article/details/78309050" target="_blank" rel="noopener">Docker下的Kafka学习之二：搭建集群环境</a><br><a href="https://www.cnblogs.com/cf532088799/p/7425021.html" target="_blank" rel="noopener">Kafka跨网络访问设置</a>  </p>
</div><div class="tags"><a href="/tags/Kafka/">Kafka</a><a href="/tags/Docker/">Docker</a></div><div class="license-space"></div><div class="license-content"><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a><span>本作品采用</span><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">'知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议'</a><span>进行许可。</span></div><div class="license-space"></div><div class="post-nav"><a class="pre" href="/2019/05/07/JS基础知识-入门篇/">JS基础知识-入门篇</a><a class="next" href="/2019/02/12/OGG+Kafka-目标端配置/">OGG+Kafka-目标端配置</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/FreshMan/">FreshMan</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Whisper/">Whisper</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/划水/">划水</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台/">后台</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/js/" style="font-size: 23px;">js</a> <a href="/tags/Echarts/" style="font-size: 16.5px;">Echarts</a> <a href="/tags/Hexo/" style="font-size: 19.75px;">Hexo</a> <a href="/tags/GitHub/" style="font-size: 16.5px;">GitHub</a> <a href="/tags/划水/" style="font-size: 10px;">划水</a> <a href="/tags/OGG/" style="font-size: 13.25px;">OGG</a> <a href="/tags/Kafka/" style="font-size: 16.5px;">Kafka</a> <a href="/tags/Docker/" style="font-size: 19.75px;">Docker</a> <a href="/tags/Oracle/" style="font-size: 16.5px;">Oracle</a> <a href="/tags/ESLint/" style="font-size: 13.25px;">ESLint</a> <a href="/tags/Python/" style="font-size: 16.5px;">Python</a> <a href="/tags/React/" style="font-size: 19.75px;">React</a> <a href="/tags/lambda/" style="font-size: 10px;">lambda</a> <a href="/tags/svn/" style="font-size: 13.25px;">svn</a> <a href="/tags/Java/" style="font-size: 13.25px;">Java</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/设计/" style="font-size: 13.25px;">设计</a> <a href="/tags/Linux/" style="font-size: 13.25px;">Linux</a> <a href="/tags/源码/" style="font-size: 10px;">源码</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/11/LeetCode-第149场周赛/">LeetCode-第149场周赛</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/07/JS基础知识-数据类型篇/">JS基础知识-数据类型篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/07/JS基础知识-入门篇/">JS基础知识-入门篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/18/Kafka-Docker环境跨主机集群安装/">Kafka-Docker环境跨主机集群安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/12/OGG+Kafka-目标端配置/">OGG+Kafka-目标端配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/02/JS-自定义事件触发在React中使用-高度自适应例/">JS-自定义事件触发在React中使用-高度自适应例</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/29/JS-参数对象新增方法/">JS-参数对象新增方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/JS-创建对象/">JS-创建对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/02/JS-bind方法参数分析/">JS-bind方法参数分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/01/OGG+Kafka-集群重启记/">OGG+Kafka-集群重启记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://strcpy.me/" title="strcpy" target="_blank">strcpy</a><ul></ul><a href="https://www.haomwei.com/" title="tufu9441" target="_blank">tufu9441</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">一点知识.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '24bfbdc1d2098a8d5cb427714572bbd5';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>